USE ImportFromExcel;
GO
SELECT * INTO Data_dq
FROM OPENROWSET('Microsoft.ACE.OLEDB.12.0',
    'Excel 12.0; Database=C:\Temp\Data.xlsx', [Sheet1$]);
GO

SELECT 
  -- финальный результирующий набор данных
  "№ договора", 
  "Наименование_дилера", 
  "Размер бонуса B2B", 
  "Размер бонуса B2C", 
  "Размер бонуса Автохимия", 
  "Общая стоимость закупленной премируемой продукции", 
  "Общий объем (т) закупленной_премируемой продукции", 
  (
    "Общий объем (т) закупленной продукции" - "Общий объем (т) закупленной премируемой продукции"
  ) as "Общий объем (т) закупленной продукции, которая не подлежит премированию" 
FROM 
  (
    SELECT 
      -- добавление к сгруппированным данным атрибута с общим объемом закупленной продукции
      * 
    FROM 
      (
        SELECT 
          -- группировка данных с суммой бонусов по типу договора и дилеру
          "№ договора", 
          "Наименование_дилера", 
          SUM(
            "Стоимость без НДС" * M_B2B_Rate
          ) as "Размер бонуса B2B", 
          SUM(
            "Стоимость без НДС" * M_B2C_Rate
          ) as "Размер бонуса B2C", 
          SUM(
            "Стоимость без НДС" * Chem_Rate
          ) as "Размер бонуса_Автохимия", 
          SUM(
            "Стоимость без НДС" * "Кол-во по фактуре"
          ) as "Общая стоимость закупленной премируемой продукции", 
          SUM(
            "Кол-во по фактуре"
          ) as "Общий объем (т) закупленной премируемой продукции" 
        FROM 
          (
            SELECT 
              -- создание полного набора необходимых данных
              "№ договора", 
              "Наименование_дилера", 
              "Цена (без НДС) за т", 
              "Кол-во по фактуре", 
              "Стоимость без НДС", 
              "Тип_дилера", 
              iB2C, 
              iB2B, 
              iChem, 
              M_B2C_Rate, 
              M_B2B_Rate, 
              Chem_Rate 
            FROM 
              VRBK 
              LEFT JOIN Bonus ON VRBK.KSSSmat = Bonus.ProdKSSS 
              LEFT JOIN Contracts ON VRBK."№_договора" = Contracts."Договор" 
            WHERE 
              "Тип_договора" = "D" 
              AND ActiveFlag = 1
          ) as FULL_TABLE 
        GROUP BY 
          "Тип_дилера", 
          "Наименование_дилера"
      ) CROSS 
      JOIN (
        SELECT 
          -- получение общего объема закупленной продукции
          SUM(
            "Кол-во по фактуре" * "Стоимость без НДС"
          ) as "Общий объем (т) закупленной продукции" 
        FROM 
          VRBK
      ) as ORDER_TOTAL
  );
